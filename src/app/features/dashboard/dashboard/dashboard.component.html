<div class="page">

   <!-- Upload -->
  <app-upload #uploadCmp (csvLoaded)="onCsvLoaded($event)"></app-upload>

  <div class="header card">
    <div>
      <h2 class="section-title">Relatório de Vendas</h2>
      <p class="subtitle">Importe um CSV e veja o resumo por produto</p>
    </div>

    <div class="actions">
      <button pButton type="button" label="Exportar CSV" icon="pi pi-download"
      class="btn-primary-green "
              (click)="exportarAgregadosCSV()"
              [disabled]="!agregadas.length"></button>
    </div>
  </div>


  <!-- Erros de parsing -->
  <div class="card" *ngIf="parseErrors.length">
    <h4>Avisos</h4>
    <ul>
      <li *ngFor="let e of parseErrors">{{ e }}</li>
    </ul>
  </div>

  <!-- Resumo -->
  <div class="grid">
    <div class="card">
      <h4 class="section-title">Total Geral</h4>
      <div class="big">{{ totalGeral | currencyBr }}</div>
    </div>

    <div class="card">
      <h4 class="section-title">Produto mais vendido</h4>
      <div class="big">
        {{ maisVendido?.produto || '-' }}
      </div>
      <div class="muted" *ngIf="maisVendido">
        Quantidade: {{ maisVendido.quantidadeTotal }}
      </div>
    </div>
  </div>

  <!-- Filtro -->
  <div class="card">
    <div class="filter-row">
      <span class="p-input-icon-left w-100">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="text"
          [(ngModel)]="filtroProduto"
          (input)="aplicarFiltro()"
          placeholder="Filtrar por produto"
          aria-label="Filtrar por produto"
          class="w-100"
        />
      </span>

      <button pButton type="button" label="Limpar" class="btn-primary-green"
              (click)="limparFiltro()"></button>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card" *ngIf="agregadasFiltradas.length; else emptyState">
    <p-table
      [value]="agregadasFiltradas"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5,10,20]"
      sortMode="multiple"
      dataKey="produto">

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="produto">
            Produto <p-sortIcon field="produto"></p-sortIcon>
          </th>
          <th pSortableColumn="quantidadeTotal">
            Quantidade <p-sortIcon field="quantidadeTotal"></p-sortIcon>
          </th>
          <th pSortableColumn="valorTotal">
            Valor Total <p-sortIcon field="valorTotal"></p-sortIcon>
          </th>
          <th>Ações</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.produto }}</td>
          <td>{{ item.quantidadeTotal }}</td>
          <td>{{ item.valorTotal | currencyBr }}</td>
          <td>
            <button pButton type="button" icon="pi pi-eye" class="p-button-text"
                    aria-label="Ver detalhes"
                    (click)="abrirDetalhe(detalheTpl, item)"></button> 
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <ng-template #emptyState>
    <div class="card">
      Nenhum dado para exibir. Importe um CSV válido.
    </div>
  </ng-template>

  <!-- Chart -->
  <div class="card" *ngIf="chartData">
    <h4 class="section-title">Quantidades por produto</h4>
    <p-chart type="bar" [data]="chartData"></p-chart>
  </div>

  <!-- Modal -->
  <ng-template #detalheTpl>
    <div class="modal-header">
      <h4 class="modal-title">Detalhes do Produto</h4>
      <button type="button" class="close" aria-label="Close" (click)="modalRef?.hide()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body" *ngIf="produtoSelecionado">
      <p><strong>Produto:</strong> {{ produtoSelecionado.produto }}</p>
      <p><strong>Quantidade:</strong> {{ produtoSelecionado.quantidadeTotal }}</p>
      <p><strong>Valor Total:</strong> {{ produtoSelecionado.valorTotal | currencyBr }}</p>
    </div>
  </ng-template>

</div>
